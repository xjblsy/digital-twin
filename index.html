<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>数字孪生考古遗址风险评估系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #020617;
      color: #e5e7eb;
      overflow: hidden;
    }

    #layout {
      display: grid;
      grid-template-rows: 56px 1fr 36px;
      height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: rgba(15,23,42,0.9);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    header h1 {
      font-size: 18px;
      font-weight: 600;
    }

    #riskLevel {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      background: #22c55e;
      color: #022c22;
      transition: all 0.3s ease;
      box-shadow: 0 0 12px rgba(0,0,0,0.4);
    }

    main {
      display: grid;
      grid-template-columns: 1fr 360px;
    }

    #viewer {
      position: relative;
    }

    #panel {
      background: rgba(15,23,42,0.95);
      border-left: 1px solid rgba(255,255,255,0.08);
      padding: 20px;
      overflow-y: auto;
    }

    h2 {
      font-size: 16px;
      margin-bottom: 6px;
    }

    .hint {
      font-size: 12px;
      opacity: 0.6;
      margin-bottom: 16px;
    }

    label {
      font-size: 12px;
      opacity: 0.8;
    }

    input, select {
      width: 100%;
      margin-top: 6px;
      margin-bottom: 14px;
      padding: 8px 10px;
      background: #020617;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px;
      color: #e5e7eb;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg,#3b82f6,#06b6d4);
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    button:hover { opacity: 0.9; }

    .metric {
      margin-top: 18px;
    }

    .metric strong {
      font-size: 22px;
    }

    footer {
      font-size: 12px;
      opacity: 0.5;
      display: flex;
      align-items: center;
      padding-left: 16px;
      background: rgba(2,6,23,0.9);
      border-top: 1px solid rgba(255,255,255,0.08);
    }
  </style>
</head>
<body>

<div id="layout">
  <header>
    <h1>数字孪生考古遗址风险评估系统</h1>
    <div id="riskLevel">安全</div>
  </header>

  <main>
    <div id="viewer"></div>

    <div id="panel">
      <h2>环境数据输入（模拟）</h2>
      <div class="hint">当前阶段采用人工输入模拟环境传感器数据，用于验证系统逻辑</div>

      <label>年降雨量 (mm)</label>
      <input id="rain" type="number" value="800" />

      <label>平均湿度 (%)</label>
      <input id="humidity" type="number" value="75" />

      <label>年温差 (℃)</label>
      <input id="temp" type="number" value="15" />

      <label>极端天气频率</label>
      <select id="extreme">
        <option value="1">低</option>
        <option value="2" selected>中</option>
        <option value="3">高</option>
      </select>

      <button onclick="handleRunPrediction()">运行风险评估</button>

      <div class="metric">
        <span>预测风险值</span><br />
        <strong id="riskValue">0.32</strong>
      </div>
    </div>
  </main>

  <footer>
    数字孪生系统原型 · 数据为模拟 · 支持后端模型替换
  </footer>
</div>

<script>
  /* ================= 模块一：数字孪生渲染层 ================= */
  const viewer = document.getElementById('viewer');
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x020617);

  const camera = new THREE.PerspectiveCamera(60, viewer.clientWidth / viewer.clientHeight, 0.1, 100);
  camera.position.set(3, 2.5, 4);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(viewer.clientWidth, viewer.clientHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  viewer.appendChild(renderer.domElement);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(5, 5, 5);
  scene.add(light);

  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(10, 10),
    new THREE.MeshStandardMaterial({ color: 0x020617 })
  );
  ground.rotation.x = -Math.PI / 2;
  ground.position.y = -0.5;
  scene.add(ground);

  const twinModel = new THREE.Mesh(
    new THREE.BoxGeometry(1.5, 1, 1.5),
    new THREE.MeshStandardMaterial({ color: 0x22c55e, emissive: 0x000000 })
  );
  scene.add(twinModel);

  /* ================= 模块二：风险映射逻辑 ================= */
  function riskToColor(risk) {
    const green = new THREE.Color(0x22c55e);
    const yellow = new THREE.Color(0xfacc15);
    const red = new THREE.Color(0xef4444);
    if (risk < 0.5) return green.lerp(yellow, risk * 2);
    return yellow.lerp(red, (risk - 0.5) * 2);
  }

  function applyRiskToTwin(risk) {
    twinModel.material.color.copy(riskToColor(risk));
    twinModel.material.emissiveIntensity = risk > 0.7 ? 0.35 : risk > 0.4 ? 0.2 : 0.05;
  }

  /* ================= 模块三：UI 状态更新 ================= */
  function updateUI(risk) {
    document.getElementById('riskValue').innerText = risk.toFixed(2);
    const badge = document.getElementById('riskLevel');

    if (risk < 0.4) {
      badge.innerText = '安全';
      badge.style.background = '#22c55e';
      badge.style.color = '#022c22';
    } else if (risk < 0.7) {
      badge.innerText = '警告';
      badge.style.background = '#facc15';
      badge.style.color = '#422006';
    } else {
      badge.innerText = '高风险';
      badge.style.background = '#ef4444';
      badge.style.color = '#450a0a';
    }
  }

  /* ================= 模块四：风险预测接口（模拟） ================= */
  function collectInputData() {
    return {
      rain: Number(document.getElementById('rain').value),
      humidity: Number(document.getElementById('humidity').value),
      temp: Number(document.getElementById('temp').value),
      extreme: Number(document.getElementById('extreme').value)
    };
  }

  function predictRisk(data) {
    let risk =
      0.0003 * data.rain +
      0.003 * data.humidity +
      0.01 * data.temp +
      0.1 * data.extreme;
    return Math.min(1, Math.max(0, risk));
  }

  function handleRunPrediction() {
    const data = collectInputData();
    const risk = predictRisk(data);
    applyRiskToTwin(risk);
    updateUI(risk);
  }

  /* ================= 渲染循环 ================= */
  function animate() {
    requestAnimationFrame(animate);
    twinModel.rotation.y += 0.002;
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener('resize', () => {
    camera.aspect = viewer.clientWidth / viewer.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(viewer.clientWidth, viewer.clientHeight);
  });
</script>
</body>
</html>
