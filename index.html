<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>3D 风险可视化 Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Three.js & helpers -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

  <!-- UI -->
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #0f172a;
      color: #e5e7eb;
      overflow: hidden;
    }

    #app {
      display: grid;
      grid-template-columns: 1fr 320px;
      height: 100vh;
    }

    #canvas-container {
      position: relative;
    }

    #panel {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(12px);
      padding: 20px;
      border-left: 1px solid rgba(255,255,255,0.1);
      box-shadow: -10px 0 30px rgba(0,0,0,0.3);
    }

    h2 {
      font-size: 18px;
      margin-bottom: 12px;
    }

    .metric {
      margin-bottom: 14px;
    }

    .metric span {
      display: block;
      font-size: 13px;
      opacity: 0.7;
    }

    .metric strong {
      font-size: 20px;
    }

    .risk-bar {
      height: 8px;
      border-radius: 6px;
      background: linear-gradient(90deg, #22c55e, #facc15, #ef4444);
      position: relative;
      margin-top: 6px;
    }

    .risk-indicator {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: white;
      position: absolute;
      top: -3px;
      transform: translateX(-50%);
    }

    button {
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    button:hover {
      opacity: 0.9;
    }

    #footer {
      position: absolute;
      bottom: 10px;
      left: 10px;
      font-size: 12px;
      opacity: 0.5;
    }
  </style>
</head>
<body>

<div id="app">
  <div id="canvas-container">
    <div id="footer">Three.js · Risk Visualization</div>
  </div>

  <div id="panel">
    <h2>风险数据面板</h2>

    <div class="metric">
      <span>当前风险值</span>
      <strong id="riskValue">0.42</strong>
      <div class="risk-bar">
        <div class="risk-indicator" id="riskIndicator" style="left:42%"></div>
      </div>
    </div>

    <div class="metric">
      <span>模型状态</span>
      <strong id="status">正常</strong>
    </div>

    <button onclick="fetchRiskFromBackend()">模拟后台数据更新</button>
  </div>
</div>

<script>
  /**
   * ============================
   * Three.js 基础场景
   * ============================
   */
  const container = document.getElementById('canvas-container');

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x020617);

  const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 100);
  camera.position.set(2.5, 2, 4);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  container.appendChild(renderer.domElement);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambientLight);

  const dirLight = new THREE.DirectionalLight(0xffffff, 1);
  dirLight.position.set(5, 5, 5);
  scene.add(dirLight);

  /**
   * ============================
   * 模型（可替换为你自己的 glTF）
   * ============================
   */
  let modelMesh;

  // 默认示例：一个立方体（你可直接换成 GLTFLoader）
  const geometry = new THREE.BoxGeometry(1, 1, 1);
  const material = new THREE.MeshStandardMaterial({ color: 0x22c55e });
  modelMesh = new THREE.Mesh(geometry, material);
  scene.add(modelMesh);

  /**
   * ============================
   * 风险 → 颜色映射
   * ============================
   */
  function riskToColor(risk) {
    // risk ∈ [0,1]
    const green = new THREE.Color(0x22c55e);
    const yellow = new THREE.Color(0xfacc15);
    const red = new THREE.Color(0xef4444);

    if (risk < 0.5) {
      return green.lerp(yellow, risk * 2);
    } else {
      return yellow.lerp(red, (risk - 0.5) * 2);
    }
  }

  function updateRisk(risk) {
    const color = riskToColor(risk);
    modelMesh.material.color.copy(color);

    document.getElementById('riskValue').innerText = risk.toFixed(2);
    document.getElementById('riskIndicator').style.left = `${risk * 100}%`;

    const status = risk < 0.4 ? '正常' : risk < 0.7 ? '警告' : '高风险';
    document.getElementById('status').innerText = status;
  }

  /**
   * ============================
   * 模拟“后台模型”交互
   * ============================
   * 实际项目中你只需替换为 fetch('/api/risk')
   */
  function fetchRiskFromBackend() {
    // mock 后台返回
    const simulatedRisk = Math.random();
    updateRisk(simulatedRisk);
  }

  /**
   * ============================
   * 动画循环
   * ============================
   */
  function animate() {
    requestAnimationFrame(animate);
    modelMesh.rotation.y += 0.003;
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener('resize', () => {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
  });
</script>

</body>
</html>
