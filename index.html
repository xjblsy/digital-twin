<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>数字孪生考古遗址风险评估系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Three.js 核心库与扩展 -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
  <!-- GLTF 加载器（为后续替换真实遗址模型预留） -->
  <script src="https://unpkg.com/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

  <!-- 字体与图标库（提升界面质感） -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    /* ==================== 全局样式 ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #020617;
      color: #e5e7eb;
      overflow: hidden;
      height: 100vh;
    }

    /* 三栏布局：头部、主体、底部 */
    #app {
      display: grid;
      grid-template-rows: 64px 1fr 40px;
      height: 100vh;
      background: linear-gradient(145deg, #0b1120 0%, #030712 100%);
    }

    /* ----- 头部（系统状态栏） ----- */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: rgba(11, 20, 30, 0.85);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .system-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .system-title i {
      color: #3b82f6;
      font-size: 20px;
    }

    .system-title h1 {
      font-size: 18px;
      font-weight: 500;
      letter-spacing: 1px;
      background: linear-gradient(135deg, #f0f9ff, #bae6fd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    #riskBadge {
      padding: 6px 18px;
      border-radius: 30px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      transition: all 0.25s ease;
    }

    /* ----- 主体（左右分栏） ----- */
    main {
      display: grid;
      grid-template-columns: 1fr 380px;
      overflow: hidden;
      position: relative;
    }

    /* 左侧：数字孪生视图区 */
    #viewer {
      position: relative;
      background: #030712;
      box-shadow: inset 0 0 40px rgba(0,0,0,0.8);
    }

    /* 右侧：控制面板 */
    #panel {
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(12px);
      border-left: 1px solid rgba(255, 255, 255, 0.06);
      padding: 28px 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      box-shadow: -4px 0 20px rgba(0,0,0,0.5);
    }

    .panel-section {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.03);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 15px;
      font-weight: 600;
      color: #94a3b8;
    }

    .section-title i {
      color: #3b82f6;
    }

    .input-group {
      margin-bottom: 18px;
    }

    .input-group label {
      display: block;
      font-size: 12px;
      margin-bottom: 6px;
      color: #cbd5e1;
      letter-spacing: 0.3px;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px 14px;
      background: #020617;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #f1f5f9;
      font-size: 14px;
      transition: all 0.2s;
    }

    .input-group input:focus,
    .input-group select:focus {
      border-color: #3b82f6;
      outline: none;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.2);
    }

    .btn-predict {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      color: white;
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }

    .btn-predict:hover {
      opacity: 0.92;
      transform: translateY(-1px);
    }

    .btn-predict:active {
      transform: translateY(1px);
    }

    .result-card {
      background: rgba(2, 6, 23, 0.6);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(59,130,246,0.2);
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 12px;
    }

    .result-label {
      font-size: 13px;
      color: #94a3b8;
    }

    .result-value {
      font-size: 28px;
      font-weight: 700;
      color: #facc15;
    }

    .prob-value {
      font-size: 22px;
      font-weight: 600;
      color: #3b82f6;
    }

    /* 底部说明栏 */
    footer {
      display: flex;
      align-items: center;
      padding-left: 24px;
      font-size: 12px;
      color: #64748b;
      background: rgba(2, 6, 23, 0.8);
      border-top: 1px solid rgba(255, 255, 255, 0.03);
      letter-spacing: 0.5px;
    }

    /* 加载动画（预留） */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div id="app">
  <!-- ==================== 头部：全局状态锚点 ==================== -->
  <header>
    <div class="system-title">
      <i class="fas fa-landmark"></i>
      <h1>数字孪生考古遗址风险评估系统</h1>
    </div>
    <div id="riskBadge">安全</div>
  </header>

  <!-- ==================== 主体：孪生体 + 控制面板 ==================== -->
  <main>
    <!-- 左侧：数字孪生渲染区（由Three.js接管） -->
    <div id="viewer"></div>

    <!-- 右侧：数据输入与风险控制面板 -->
    <div id="panel">
      <!-- 环境因子输入区块（与文档数据结构完全一致） -->
      <div class="panel-section">
        <div class="section-title">
          <i class="fas fa-microchip"></i>
          <span>环境感知数据（模拟）</span>
        </div>
        <div class="input-group">
          <label><i class="fas fa-droplet"></i> 年降雨量 (mm)</label>
          <input type="number" id="rainfall" value="800" step="10" min="0" max="3000">
        </div>
        <div class="input-group">
          <label><i class="fas fa-water"></i> 平均湿度 (%)</label>
          <input type="number" id="humidity" value="75" step="1" min="0" max="100">
        </div>
        <div class="input-group">
          <label><i class="fas fa-temperature-high"></i> 年温差 (℃)</label>
          <input type="number" id="tempVariance" value="15" step="0.5" min="0" max="50">
        </div>
        <div class="input-group">
          <label><i class="fas fa-cloud-showers-heavy"></i> 极端天气频率</label>
          <select id="extremeWeather">
            <option value="1">低</option>
            <option value="2" selected>中</option>
            <option value="3">高</option>
          </select>
        </div>
        <button class="btn-predict" onclick="handlePrediction()">
          <i class="fas fa-play"></i> 运行风险评估
        </button>
      </div>

      <!-- 预测结果展示区（与后端返回结构对应） -->
      <div class="result-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <span style="font-size:14px; color:#94a3b8;"><i class="fas fa-chart-line"></i> 实时风险指数</span>
          <span id="riskValue" style="font-size:32px; font-weight:700; color:#facc15;">0.32</span>
        </div>
        <div class="result-row">
          <span class="result-label">风险等级</span>
          <span id="riskLevelText" style="font-weight:600; padding:4px 12px; border-radius:20px; background:rgba(34,197,94,0.2); color:#22c55e;">低风险</span>
        </div>
        <div class="result-row">
          <span class="result-label">高风险概率</span>
          <span id="highRiskProb" class="prob-value">12%</span>
        </div>
      </div>

      <!-- 模型说明与扩展入口（为后续GLTF建模预留） -->
      <div style="font-size:12px; color:#64748b; padding:8px 12px; border-top:1px solid rgba(255,255,255,0.06); margin-top:8px;">
        <i class="fas fa-cube"></i> 孪生模型：当前为示意几何体，<a href="#" style="color:#3b82f6;" onclick="alert('预留接口：可在此加载真实遗址GLTF模型'); return false;">点击载入真实模型</a>（开发中）
      </div>
    </div>
  </main>

  <!-- ==================== 底部：系统边界说明 ==================== -->
  <footer>
    <i class="fas fa-flask" style="margin-right:6px;"></i>
    数字孪生原型 · 数据为模拟 · 已预留后端预测接口 (POST /predict) · 遵循模块化设计
  </footer>
</div>

<script>
  // ============================================================================
  // 数字孪生考古遗址风险评估系统 - 前端核心逻辑
  // 严格遵循技术文档划分的四大模块，结构清晰，零耦合，易于扩展。
  // ============================================================================

  // ----------------------------------------------------------------------------
  // 模块一：数字孪生渲染模块 (Digital Twin Rendering Layer)
  // 职责：初始化Three.js场景、相机、光源、控制器；负责模型加载与显示。
  // 设计原则：只关心“如何显示”，不关心“显示什么风险”。
  // ----------------------------------------------------------------------------
  const TwinRenderer = (function() {
    // 私有变量
    const viewer = document.getElementById('viewer');
    let scene, camera, renderer, controls, twinModel;

    function init() {
      // 场景
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x030712);

      // 相机 (透视相机，适应遗址尺度)
      camera = new THREE.PerspectiveCamera(45, viewer.clientWidth / viewer.clientHeight, 0.1, 1000);
      camera.position.set(4, 3, 5);
      camera.lookAt(0, 0, 0);

      // 渲染器
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(viewer.clientWidth, viewer.clientHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.shadowMap.enabled = true; // 为后续真实模型准备
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      viewer.appendChild(renderer.domElement);

      // 控制器
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.autoRotate = false;
      controls.enableZoom = true;
      controls.target.set(0, 0.2, 0);

      // 光照系统
      const ambientLight = new THREE.AmbientLight(0x404060);
      scene.add(ambientLight);

      const mainLight = new THREE.DirectionalLight(0xffeedd, 1.2);
      mainLight.position.set(5, 5, 5);
      mainLight.castShadow = true;
      mainLight.receiveShadow = true;
      scene.add(mainLight);

      const fillLight = new THREE.DirectionalLight(0x6688aa, 0.6);
      fillLight.position.set(-5, 2, 3);
      scene.add(fillLight);

      // 辅助地面（为遗址提供空间参照）
      const gridHelper = new THREE.GridHelper(12, 20, 0x3b82f6, 0x1e293b);
      gridHelper.position.y = -0.3;
      scene.add(gridHelper);

      // ---------- 数字孪生模型 ----------
      // 当前阶段：使用简化几何体作为遗址占位符，后续可无缝替换为 GLTF 模型
      // 预留模型加载入口：const loader = new THREE.GLTFLoader(); loader.load('path/to/model.glb', ...)
      const geometry = new THREE.BoxGeometry(1.8, 0.8, 1.8);
      const material = new THREE.MeshStandardMaterial({
        color: 0x22c55e,
        emissive: 0x000000,
        roughness: 0.4,
        metalness: 0.2,
        emissiveIntensity: 0.05
      });
      twinModel = new THREE.Mesh(geometry, material);
      twinModel.castShadow = true;
      twinModel.receiveShadow = true;
      twinModel.position.y = 0.1;
      scene.add(twinModel);

      // 添加一些环境装饰（提升空间感知）
      const pillarMat = new THREE.MeshStandardMaterial({ color: 0x475569, roughness: 0.7 });
      for (let i = 0; i < 4; i++) {
        const pillar = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 0.6), pillarMat);
        pillar.position.x = (i % 2 === 0 ? -1.2 : 1.2);
        pillar.position.z = (i < 2 ? -1.2 : 1.2);
        pillar.position.y = 0;
        pillar.castShadow = true;
        pillar.receiveShadow = true;
        scene.add(pillar);
      }

      // 启动动画循环
      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    // 窗口大小自适应
    window.addEventListener('resize', () => {
      if (!viewer || !camera || !renderer) return;
      camera.aspect = viewer.clientWidth / viewer.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(viewer.clientWidth, viewer.clientHeight);
    });

    // 公共接口：获取孪生模型，用于风险映射
    function getTwinModel() {
      return twinModel;
    }

    // 预留：加载真实GLTF模型（后续替换）
    function loadRealModel(gltfPath) {
      // const loader = new THREE.GLTFLoader();
      // loader.load(gltfPath, (gltf) => {
      //   scene.remove(twinModel);
      //   twinModel = gltf.scene;
      //   scene.add(twinModel);
      //   // 调整位置、缩放...
      // });
      console.log('预留真实模型加载接口，当前路径:', gltfPath);
    }

    return { init, getTwinModel, loadRealModel };
  })();

  // ----------------------------------------------------------------------------
  // 模块二：风险映射与孪生状态模块 (Risk-to-Twin Mapping Layer)
  // 职责：将[0,1]风险值映射为孪生模型的颜色、自发光强度等视觉状态。
  // 设计原则：只负责“如何表达风险”，不关心风险值来源。
  // ----------------------------------------------------------------------------
  const RiskMapper = (function() {
    // 连续颜色映射：绿 -> 黄 -> 红
    function riskToColor(risk) {
      const green = new THREE.Color(0x22c55e);
      const yellow = new THREE.Color(0xfacc15);
      const red = new THREE.Color(0xef4444);
      if (risk < 0.5) return green.clone().lerp(yellow, risk * 2);
      return yellow.clone().lerp(red, (risk - 0.5) * 2);
    }

    // 应用风险状态到孪生模型
    function applyRisk(risk) {
      const model = TwinRenderer.getTwinModel();
      if (!model) return;
      model.material.color.copy(riskToColor(risk));
      // 高风险增强自发光，营造警示氛围
      if (risk > 0.7) {
        model.material.emissiveIntensity = 0.4;
        model.material.emissive.setHex(0xef4444);
      } else if (risk > 0.4) {
        model.material.emissiveIntensity = 0.2;
        model.material.emissive.setHex(0xfacc15);
      } else {
        model.material.emissiveIntensity = 0.05;
        model.material.emissive.setHex(0x000000);
      }
    }

    return { applyRisk };
  })();

  // ----------------------------------------------------------------------------
  // 模块三：用户界面与状态管理模块 (UI State Management Layer)
  // 职责：同步UI元素（风险值、等级徽章、概率显示）与系统内部状态。
  // 设计原则：所有UI更新集中处理，避免状态不一致。
  // ----------------------------------------------------------------------------
  const UIUpdater = (function() {
    // 更新整个界面的风险展示
    function updateUI(risk, riskLevel, highProb) {
      // 风险数值
      document.getElementById('riskValue').innerText = risk.toFixed(2);
      
      // 高风险概率（百分比）
      document.getElementById('highRiskProb').innerText = (highProb * 100).toFixed(1) + '%';

      // 顶部风险等级徽章 & 右侧等级标签
      const badge = document.getElementById('riskBadge');
      const levelText = document.getElementById('riskLevelText');
      
      if (riskLevel === '低风险' || risk < 0.4) {
        badge.innerText = '安全';
        badge.style.background = '#22c55e';
        badge.style.color = '#022c22';
        levelText.innerText = '低风险';
        levelText.style.background = 'rgba(34,197,94,0.2)';
        levelText.style.color = '#22c55e';
      } else if (riskLevel === '中风险' || (risk >= 0.4 && risk < 0.7)) {
        badge.innerText = '警告';
        badge.style.background = '#facc15';
        badge.style.color = '#422006';
        levelText.innerText = '中风险';
        levelText.style.background = 'rgba(250,204,21,0.2)';
        levelText.style.color = '#facc15';
      } else {
        badge.innerText = '高风险';
        badge.style.background = '#ef4444';
        badge.style.color = '#450a0a';
        levelText.innerText = '高风险';
        levelText.style.background = 'rgba(239,68,68,0.2)';
        levelText.style.color = '#ef4444';
      }
    }

    return { updateUI };
  })();

  // ----------------------------------------------------------------------------
  // 模块四：数据感知与风险预测接口模块 (Data & Prediction Interface Layer)
  // 职责：采集环境数据，与后端预测模型交互，返回风险结果。
  // 设计原则：严格按照文档定义的JSON结构，支持无缝替换为真实后端接口。
  // ----------------------------------------------------------------------------
  const PredictionService = (function() {
    // 1. 采集前端表单数据 -> 生成与文档完全一致的请求体
    function collectInput() {
      return {
        rainfall: Number(document.getElementById('rainfall').value),
        humidity: Number(document.getElementById('humidity').value),
        temperature_variance: Number(document.getElementById('tempVariance').value),
        extreme_weather: Number(document.getElementById('extremeWeather').value)
      };
    }

    // 2. 模拟预测函数（当前阶段：线性加权 + 归一化）
    //    未来只需替换此函数为真实的 fetch API 调用即可
     // ✅ 真实 API 调用（异步）
    async function realPredict(data) {
      const url = 'https://risk-predict-model.zeabur.app/predict'; // 替换为您的真实后端地址
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          // 如果后端返回 HTTP 错误，抛出异常
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        // 假设后端返回的字段为：risk, risk_level, high_risk_probability
        // 请根据实际返回字段调整
        return {
          risk: result.risk,
          risk_level: result.risk_level,
          high_risk_probability: result.high_risk_probability,
        };
      } catch (error) {
        console.error('预测请求失败:', error);
        // 可在此处弹出错误提示
        alert('预测失败：' + error.message);
        // 返回一个默认值，防止页面崩溃
        return { risk: 0.32, risk_level: '低风险', high_risk_probability: 0.12 };
      }
    }

    return { collectInput, predict: realPredict }; // 将 predict 指向 realPredict
  })();

  // ----------------------------------------------------------------------------
  // 全局预测流程控制器（协调各模块）
  // ----------------------------------------------------------------------------
  window.handlePrediction = async function() {
    // 1. 采集输入
    const inputData = PredictionService.collectInput();
    
    // 2. 调用预测服务（当前为模拟，后续可一键切换为真实API）
    const result = PredictionService.predict(inputData);
    
    // 3. 风险映射到孪生体
    RiskMapper.applyRisk(result.risk);
    
    // 4. 更新UI状态
    UIUpdater.updateUI(result.risk, result.risk_level, result.high_risk_probability);
  };

  // ----------------------------------------------------------------------------
  // 初始化系统：渲染孪生场景、设置默认UI、加载示例数据
  // ----------------------------------------------------------------------------
  (function initSystem() {
    // 启动三维渲染
    TwinRenderer.init();

    // 设置默认风险状态（执行一次模拟预测）
    setTimeout(() => {
      const defaultData = PredictionService.collectInput();
      const defaultResult = PredictionService.predict(defaultData);
      RiskMapper.applyRisk(defaultResult.risk);
      UIUpdater.updateUI(defaultResult.risk, defaultResult.risk_level, defaultResult.high_risk_probability);
    }, 100);
  })();

  // 预留：载入真实GLTF模型的示例函数（可通过控制台调用）
  window.loadRealTwinModel = (path) => {
    TwinRenderer.loadRealModel(path);
  };
</script>
</body>
</html>
